name: E2E Tests After Deploy

on:
  workflow_run:
    workflows: ["Deploy"]
    types: [completed]

permissions:
  contents: write
  actions: read

jobs:
  setup:
    # ‚úÖ Only run when Deploy succeeded AND was run from roa-archetype
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'roa-archetype'
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Download deployed version artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: deployed-version
          path: artifacts
          if_no_artifact_found: ignore

      - name: Read version file
        id: read
        shell: bash
        run: |
          if [ -f artifacts/deployed-version/version.txt ]; then
            ver=$(cat artifacts/deployed-version/version.txt)
            echo "deployed_version=${ver}" >> "$GITHUB_ENV"
            echo "Found deployed version (nested): ${ver}"
          elif [ -f artifacts/version.txt ]; then
            ver=$(cat artifacts/version.txt)
            echo "deployed_version=${ver}" >> "$GITHUB_ENV"
            echo "Found deployed version (flat): ${ver}"
          else
            echo "No deployed-version artifact found or version.txt missing"
          fi

      - name: Check out code
        uses: actions/checkout@v4
        with:
          repository: CyborgCodeSyndicate/roa-example-projects
          # ‚úÖ Better: test the exact code that was deployed
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Maven Environment
        uses: CyborgCodeSyndicate/utilities/pipelines/shared/setup-maven@v1.4.1
        with:
          server_ids: github-roa-libraries,github-roa-plugins
          github_packages_user: ${{ secrets.GH_PACKAGES_USER }}
          github_packages_token: ${{ secrets.GH_PACKAGES_PAT }}

      - name: Override parent version
        if: ${{ env.deployed_version != '' }}
        run: |
          echo "üìù Setting parent version to: ${{ env.deployed_version }}"
          mvn -B -ntp versions:update-parent \
            -DparentVersion="[${{ env.deployed_version }}]" \
            -DallowSnapshots=true \
            -DprocessAllModules=true \
            -DgenerateBackupPoms=false

      - name: Verify compile (fail fast if broken)
        run: mvn -B -ntp -U compile

  e2e-api:
    needs: setup
    # ‚úÖ Guard these too (reusable workflow jobs won't run if setup is skipped, but this is explicit)
    if: ${{ needs.setup.result == 'success' }}
    uses: CyborgCodeSyndicate/roa-github-workflows/.github/workflows/roa-tests.yml@v1.0.4
    with:
      kind: api
      project_module: api-test-framework
      repository: CyborgCodeSyndicate/roa-example-projects
      tags_include: Smoke
      tags_exclude: Flaky
      grid_node_max_sessions: 3
    secrets:
      maven_user: ${{ secrets.GH_PACKAGES_USER }}
      maven_token: ${{ secrets.GH_PACKAGES_PAT }}

  e2e-ui-simple:
    needs: setup
    if: ${{ needs.setup.result == 'success' }}
    uses: CyborgCodeSyndicate/roa-github-workflows/.github/workflows/roa-tests.yml@v1.0.4
    with:
      kind: ui
      project_module: ui-simple-test-framework
      repository: CyborgCodeSyndicate/roa-example-projects
      tags_include: Smoke
      tags_exclude: Flaky
      grid_node_max_sessions: 3
    secrets:
      maven_user: ${{ secrets.GH_PACKAGES_USER }}
      maven_token: ${{ secrets.GH_PACKAGES_PAT }}

  e2e-ui-complex:
    needs: setup
    if: ${{ needs.setup.result == 'success' }}
    uses: CyborgCodeSyndicate/roa-github-workflows/.github/workflows/roa-tests.yml@v1.0.4
    with:
      kind: ui
      project_module: ui-complex-test-framework
      repository: CyborgCodeSyndicate/roa-example-projects
      tags_include: Smoke
      tags_exclude: Flaky
      grid_node_max_sessions: 3
    secrets:
      maven_user: ${{ secrets.GH_PACKAGES_USER }}
      maven_token: ${{ secrets.GH_PACKAGES_PAT }}
