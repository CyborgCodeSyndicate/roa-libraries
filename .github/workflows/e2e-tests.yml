name: E2E UI-COMPLEX Tests After Deploy

on:
  workflow_call:
    inputs:
      deployed_version:
        description: "Snapshot version to test"
        required: true
        type: string
    secrets:
      gh_packages_user:
        required: true
      gh_packages_pat:
        required: true

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          repository: CyborgCodeSyndicate/roa-example-projects
          ref: e2e-flow

      - name: Setup Maven Environment
        uses: CyborgCodeSyndicate/utilities/pipelines/shared/setup-maven@v1.3.2
        with:
          server_ids: github-roa-libraries,github-roa-plugins
          github_packages_user: ${{ secrets.gh_packages_user }}
          github_packages_token: ${{ secrets.gh_packages_pat }}

      - name: Override parent version (optional)
        if: ${{ inputs.deployed_version != '' }}
        run: |
          echo "üìù Setting parent version to: ${{ inputs.deployed_version }}"
          mvn -B -ntp versions:update-parent \
            -DparentVersion="[${{ inputs.deployed_version }}]" \
            -DallowSnapshots=true \
            -DprocessAllModules=true \
            -DgenerateBackupPoms=false \
            --no-transfer-progress  

      - name: Verify compile (fail fast if broken)
        run: |
          mvn -ntp -U compile

  e2e-api:
    needs: setup
    uses: CyborgCodeSyndicate/roa-github-workflows/.github/workflows/roa-tests-pm.yml@e2e-flow
    with:
      kind: api
      project_module: api-test-framework
      tags_include: Smoke
      repository: CyborgCodeSyndicate/roa-example-projects
      ref: e2e-flow
    secrets:
      maven_user: ${{ secrets.gh_packages_user }}
      maven_token: ${{ secrets.gh_packages_pat }}

  e2e-ui-complex:
    needs: setup
    uses: CyborgCodeSyndicate/roa-github-workflows/.github/workflows/roa-tests-pm.yml@e2e-flow
    with:
      kind: ui
      project_module: ui-complex-test-framework
      tags_include: Smoke
      repository: CyborgCodeSyndicate/roa-example-projects
      ref: e2e-flow
    secrets:
      maven_user: ${{ secrets.gh_packages_user }}
      maven_token: ${{ secrets.gh_packages_pat }}