name: E2E Tests After Deploy

on:
  workflow_run:
    workflows: [ "Deploy" ]
    types: [ completed ]

permissions:
  contents: write
  actions: read

jobs:
  setup:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'e2e-flow' }}
    runs-on: ubuntu-latest
    outputs:
      deployed_version: ${{ steps.read.outputs.deployed_version }}
    steps:
      - name: Download deployed version artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: deployed-version
          path: artifacts
          if_no_artifact_found: ignore

      - name: Read version file
        id: read
        shell: bash
        run: |
          if [ -f artifacts/deployed-version/version.txt ]; then
            ver=$(cat artifacts/deployed-version/version.txt)
            echo "deployed_version=${ver}" >> "$GITHUB_OUTPUT"
            echo "deployed_version=${ver}" >> "$GITHUB_ENV"
            echo "Found deployed version (nested): ${ver}"
          elif [ -f artifacts/version.txt ]; then
            ver=$(cat artifacts/version.txt)
            echo "deployed_version=${ver}" >> "$GITHUB_OUTPUT"
            echo "deployed_version=${ver}" >> "$GITHUB_ENV"
            echo "Found deployed version (flat): ${ver}"
          else
            echo "deployed_version=" >> "$GITHUB_OUTPUT"
            echo "No deployed-version artifact found or version.txt missing"
          fi

      - name: Check out example projects
        uses: actions/checkout@v4
        with:
          repository: CyborgCodeSyndicate/roa-example-projects
          ref: e2e-flow

      - name: Setup Maven Environment
        uses: CyborgCodeSyndicate/utilities/pipelines/shared/setup-maven@v1.3.2
        with:
          server_ids: github-roa-libraries,github-roa-plugins
          github_packages_user: ${{ secrets.GH_PACKAGES_USER }}
          github_packages_token: ${{ secrets.GH_PACKAGES_PAT }}

      - name: Override parent version (optional)
        if: ${{ env.deployed_version != '' }}
        run: |
          echo "üìù Setting parent version to: ${{ env.deployed_version }}"
          mvn -B -ntp versions:update-parent \
            -DparentVersion="[${{ env.deployed_version }}]" \
            -DallowSnapshots=true \
            -DprocessAllModules=true \
            -DgenerateBackupPoms=false \
            --no-transfer-progress  

      - name: Verify compile (fail fast if broken)
        run: mvn -ntp -U compile

  e2e-api:
    needs: setup
    uses: CyborgCodeSyndicate/roa-github-workflows/.github/workflows/roa-tests-pm.yml@e2e-flow
    with:
      kind: api
      project_module: api-test-framework
      tags_include: Smoke
      repository: CyborgCodeSyndicate/roa-example-projects
      ref: e2e-flow
    secrets:
      maven_user: ${{ secrets.GH_PACKAGES_USER }}
      maven_token: ${{ secrets.GH_PACKAGES_PAT }}

  e2e-ui-complex:
    needs: setup
    uses: CyborgCodeSyndicate/roa-github-workflows/.github/workflows/roa-tests-pm.yml@e2e-flow
    with:
      kind: ui
      project_module: ui-complex-test-framework
      tags_include: Smoke
      repository: CyborgCodeSyndicate/roa-example-projects
      ref: e2e-flow
    secrets:
      maven_user: ${{ secrets.GH_PACKAGES_USER }}
      maven_token: ${{ secrets.GH_PACKAGES_PAT }}